<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŸ³ç¬¦å¿ƒè‡Ÿç—…</title>
  <style>
    :root{ --line:#e5e7eb; --ink:#0f172a; --ok:#16a34a; --blue:#0ea5e9; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font-family:system-ui,"Noto Sans TC","PingFang TC",Arial;overflow:hidden}
    header{padding:10px 12px 0;text-align:center}
    h1{margin:8px 0 6px;font-size:22px}
    main{padding:8px 12px 12px;height:calc(100svh - 48px);}
    .panel{max-width:960px;margin:0 auto;height:100%;border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center}
    .stat{border:1px solid var(--line);background:#f3f4f6;border-radius:12px;padding:6px 10px;font-weight:800}
    .slider{display:flex;gap:8px;align-items:center}
    input[type=range]{width:200px}
    button{border:1px solid var(--line);background:#f8fafc;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .primary{background:var(--blue);color:#fff;border-color:#0284c7}
    .stage{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;border:1px solid var(--line);border-radius:16px;padding:10px;min-height:0}
    .zone{width:min(88vw, 520px);aspect-ratio: 1 / 1;border:1px solid var(--line);border-radius:14px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fff}
    #cardImage{ width:92%; height:92%; object-fit:contain; display:block }
    .hitbar{display:flex; justify-content:center}
    #hitBtn{width:360px; max-width:100%; padding:14px; border:0; border-radius:14px; background:var(--ok); color:#fff; font-weight:900; touch-action:manipulation}
    .msg{min-height:24px; font-weight:800; color:#065f46}

    /* Overlays */
    .overlay{position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000}
    .sheet{max-width:880px;width:100%;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden}
    .sheet header{padding:14px 16px;border-bottom:1px solid var(--line)}
    .sheet .content{padding:16px}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:760px){ .grid2{grid-template-columns:1fr 1fr} }
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fafafa}
    .big{padding:14px 16px;font-size:16px;border-radius:12px}

    /* Mobile tweaks */
    @media (max-width:640px){
      .toolbar{gap:6px}
      button{padding:10px 12px}
      input[type=range]{width:150px}
      .stat{padding:6px 8px}
      #hitBtn{padding:16px}
    }

    /* Leaderboard table */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:center;font-size:14px}
    th{background:#f8fafc}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#f9fafb;font-weight:800;margin-right:8px}
    .grade{font-size:26px;font-weight:900}
    .good{color:#0f766e}.mid{color:#2563eb}.low{color:#b45309}.badc{color:#b91c1c}
  </style>
</head>
<body onload="showStartScreen()">
<header>
  <h1>éŸ³ç¬¦å¿ƒè‡Ÿç—…</h1>
</header>

<main>
  <div class="panel">
    <div class="toolbar">
      <button id="start" class="primary">â–¶ é–‹å§‹</button>
      <button id="pause">â¸ï¸ æš«åœ/ç¹¼çºŒ</button>
      <button id="reset">â†º é‡ç½®</button>
      <button id="board">ğŸ† æ’è¡Œæ¦œ</button>
      <span class="stat">æ­£ç¢ºï¼š<span id="hitCount">0</span></span>
      <span class="stat">éŒ¯èª¤ï¼š<span id="wrong">0</span></span>
      <span class="stat">æ¼æ‹ï¼š<span id="missed">0</span></span>
      <div class="slider">
        <label for="speed">é€Ÿåº¦</label>
        <input id="speed" type="range" min="400" max="2500" step="50" value="1500">
        <span id="speedLabel">1.50s</span>
      </div>
      <div class="slider">
        <label for="mismatch">å›°é›£ç¨‹åº¦</label>
        <input id="mismatch" type="range" min="0" max="100" step="5" value="35">
        <span id="mismatchLabel">35%</span>
      </div>
      <div class="slider">
        <label for="volume">éŸ³é‡</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="1">
      </div>
    </div>

    <div class="stage">
      <div class="zone"><img id="cardImage" alt="å¡ç‰Œ"></div>
      <div class="msg" id="msg"></div>
      <div class="hitbar"><button id="hitBtn">æ‹ç‰Œï¼ˆSpaceï¼‰</button></div>
    </div>
  </div>
</main>

<!-- Intro -->
<div id="intro" class="overlay">
  <div class="sheet">
    <header><b>éŠæˆ²è§£èªª</b></header>
    <div class="content">
      <div class="grid2">
        <div class="card">
          <p>æ¯å¼µç‰Œæœƒé¡¯ç¤ºåœ–å¡ï¼Œä¸¦æ’­æ”¾éŸ³é«˜çš„è²éŸ¿ã€‚<br>
          ï¼ˆè‹¥éŸ³æª”æ’­æ”¾å¤±æ•—ï¼Œè«‹å°‡æ‰‹æ©ŸåŠå¹³æ¿é—œé–‰éœéŸ³æˆ–æ˜¯é‡æ–°æ‰“é–‹é é¢å³å¯å¾—åˆ°éŸ³æª”ä¿®å¾©ï¼‰</p>
          <p><b>ç•¶ã€Œè½åˆ°çš„éŸ³ã€èˆ‡ã€Œç‰Œé¢éŸ³é«˜ã€ç›¸åŒæ™‚ï¼Œè«‹æ‹ç‰Œã€‚</b></p>
          <p>âœ” æ‹å° +1ã€€âœ˜ æ‹éŒ¯ -1ã€€â± æ¼æ‹ -1</p>
        </div>
        <div class="card">
          <div style="display:flex;gap:10px;align-items:center;margin:6px 0">
            <label for="prefSpeed">é€Ÿåº¦</label>
            <input id="prefSpeed" type="range" min="400" max="2500" step="50" value="1500">
            <span id="prefSpeedLabel">1.50s</span>
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin:6px 0">
            <label for="prefMismatch">å›°é›£ç¨‹åº¦</label>
            <input id="prefMismatch" type="range" min="0" max="100" step="5" value="35">
            <span id="prefMismatchLabel">35%</span>
          </div>
          <button id="startNow" class="primary big">â–¶ é–‹å§‹éŠæˆ²</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Result -->
<div id="result" class="overlay" style="display:none;">
  <div class="sheet">
    <header><b>æœ¬æ¬¡æˆç¸¾</b></header>
    <div class="content">
      <div class="pill">æ­£ç¢ºï¼š<b id="rHit">0</b></div>
      <div class="pill">éŒ¯èª¤ï¼š<b id="rWrong">0</b></div>
      <div class="pill">æ¼æ‹ï¼š<b id="rMissed">0</b></div>
      <div class="pill">æ­£ç¢ºç‡ï¼š<b id="rAcc">0%</b></div>
      <p id="rGrade" class="grade good">å¤ªå¼·äº†ï¼</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="retry" class="primary big">å†ç©ä¸€æ¬¡</button>
      </div>
    </div>
  </div>
</div>

<!-- Leaderboard -->
<div id="leader" class="overlay" style="display:none;">
  <div class="sheet">
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <b>æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰</b>
      <div>
        <button id="clearBoard">æ¸…é™¤å…¨éƒ¨</button>
        <button id="closeBoard" class="primary">é—œé–‰</button>
      </div>
    </header>
    <div class="content">
      <div class="card" style="overflow:auto;max-height:min(70svh,520px);">
        <table id="boardTable">
          <thead>
            <tr><th>#</th><th>ç©å®¶</th><th>æ­£ç¢ºç‡</th><th>æ­£/éŒ¯/æ¼</th><th>é€Ÿåº¦</th><th>å›°é›£</th><th>æ™‚é–“</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <small>æç¤ºï¼šæ’è¡Œæ¦œè³‡æ–™å„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼ˆæœ¬æ©Ÿï¼‰ã€‚</small>
    </div>
  </div>
</div>

<script>
/* ========= 42 å¼µå¡ç‰Œèˆ‡éŸ³æª” ========= */
const CARDS = [
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰é–“faäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰é–“fa.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰ç·šsoläº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰ç·šsol.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ å…©é–“reäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ å…©é–“re.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ å…©ç·šmiäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ å…©ç·šmi.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸‰é–“soläº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸‰é–“sol.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸‰ç·šfaäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸‰ç·šfa.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ å…©é–“siäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹åŠ å…©é–“si.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ å…©ç·šlaäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹åŠ å…©ç·šla.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“siäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€é–“faäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€é–“fa.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰é–“siäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰é–“si.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ å…©é–“reäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ å…©é–“re.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬ä¸€é–“laäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬ä¸€é–“la.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬äºŒé–“doäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬äºŒé–“do.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“miäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬äº”ç·šlaäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬å››ç·šfaäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šlaäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šla.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰ç·šmiäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰ç·šmi.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©ç·šdoäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©ç·šdo.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdoäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmiäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsoläº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsiäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬å››é–“miäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬å››é–“mi.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©é–“siäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ å…©é–“si.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“reäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“faäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“laäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“doäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“do.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬äº”ç·šfaäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬äº”ç·šfa.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿç¬¬å››ç·šreäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿç¬¬å››ç·šre.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdoäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šmiäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šmi.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰ç·šlaäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸‰ç·šla.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿä¸‹åŠ å…©ç·šdoäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿä¸‹åŠ å…©ç·šdo.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬ä¸€ç·šsoläº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬ä¸€ç·šsol.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬äºŒç·šsiäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬äºŒç·šsi.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šreäº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre.mp3"},
  {img:"assets/ä½éŸ³è­œè™Ÿç¬¬å››é–“soläº”ç·šè­œ.png", audio:"audio/ä½éŸ³è­œè™Ÿç¬¬å››é–“sol.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“soläº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“sol.mp3"},
  {img:"assets/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰é–“reäº”ç·šè­œ.png", audio:"audio/é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸‰é–“re.mp3"}
];

/* ========= éŠæˆ²ç‹€æ…‹ ========= */
let running=false, paused=false, timer=null;
let interval=1500;
let idx=0, TOTAL_QUESTIONS=30;
let hitCount=0, wrong=0, missed=0;
let shouldHit=false, currentAudio=null;
let currentIsCorrectSound=false;

const imgEl = document.getElementById('cardImage');
const msgEl = document.getElementById('msg');
const hitEl = document.getElementById('hitCount');
const wrongEl = document.getElementById('wrong');
const missedEl = document.getElementById('missed');
const speedEl = document.getElementById('speed');
const speedLabel = document.getElementById('speedLabel');
const volEl = document.getElementById('volume');
const mismatchEl = document.getElementById('mismatch');
const mismatchLabel = document.getElementById('mismatchLabel');

function showStartScreen(){ document.getElementById('intro').style.display='flex'; }
function updateStats(){ hitEl.textContent=hitCount; wrongEl.textContent=wrong; missedEl.textContent=missed; }
mismatchEl.addEventListener('input',e=>{ mismatchLabel.textContent = e.target.value + '%'; });
speedEl.addEventListener('input',e=>{ interval=parseInt(e.target.value,10); speedLabel.textContent=(interval/1000).toFixed(2)+'s'; });

function playAudio(src){
  try{ if(currentAudio){ currentAudio.pause(); } }catch(e){}
  const a = new Audio(src);
  a.volume = parseFloat(volEl.value);
  a.play().catch(()=>{
    // å¤±æ•—æç¤ºï¼ˆç¶­æŒä½ è¦çš„è¨Šæ¯ï¼‰
    msgEl.textContent = "ï¼ˆåµæ¸¬åˆ°æ’­æ”¾å¤±æ•—ï¼Œè«‹é—œé–‰éœéŸ³ï¼‰";
  });
  currentAudio = a;
}

function makeQuestion(card){
  const chance = parseInt(mismatchEl.value,10); // å›°é›£ç¨‹åº¦ï¼å‡ºéŒ¯æ©Ÿç‡%
  if(Math.random()*100 < chance){
    let picked;
    do { picked = CARDS[Math.floor(Math.random()*CARDS.length)]; } while (picked.audio === card.audio);
    return {shouldHit:false, audioSrc:picked.audio, isCorrect:false};
  }else{
    return {shouldHit:true, audioSrc:card.audio, isCorrect:true};
  }
}

function nextStep(){
  if(!running || paused) return;
  if(idx>0 && shouldHit){ missed++; updateStats(); }
  if(idx>=TOTAL_QUESTIONS){ finish(); return; }

  const card = CARDS[Math.floor(Math.random()*CARDS.length)];
  imgEl.src = card.img;
  imgEl.onerror = ()=>{ msgEl.textContent="æ‰¾ä¸åˆ°åœ–ç‰‡ï¼š"+card.img; };

  const q = makeQuestion(card);
  shouldHit = q.shouldHit;
  currentIsCorrectSound = q.isCorrect;
  playAudio(q.audioSrc);

  idx++;
  timer = setTimeout(nextStep, interval);
}

function startGame(){
  if(running) return;
  document.getElementById('intro').style.display='none';
  document.getElementById('result').style.display='none';

  interval = parseInt(document.getElementById('prefSpeed').value,10);
  document.getElementById('speed').value = interval;
  document.getElementById('speedLabel').textContent=(interval/1000).toFixed(2)+'s';

  const prefMis = parseInt(document.getElementById('prefMismatch').value,10);
  document.getElementById('mismatch').value = prefMis;
  document.getElementById('mismatchLabel').textContent = prefMis + '%';

  idx=0; hitCount=0; wrong=0; missed=0; shouldHit=false; currentIsCorrectSound=false; updateStats(); msgEl.textContent='éŠæˆ²é–‹å§‹ï¼';
  running=true; paused=false;
  nextStep();
}
function togglePause(){ if(!running) return; paused=!paused; msgEl.textContent = paused?'å·²æš«åœï¼ˆå†æŒ‰å¯ç¹¼çºŒï¼‰':'ç¹¼çºŒä¸­â€¦'; if(!paused) nextStep(); }
function resetGame(){ running=false; paused=false; if(timer){clearTimeout(timer); timer=null;} idx=0; hitCount=0; wrong=0; missed=0; shouldHit=false; currentIsCorrectSound=false; updateStats(); imgEl.removeAttribute('src'); msgEl.textContent='å·²é‡ç½®ã€‚'; }
function onHit(){
  if(!running || paused) return;
  if(shouldHit){ hitCount++; shouldHit=false; msgEl.textContent='âœ” æ‹å°äº†ï¼'; if(navigator.vibrate) navigator.vibrate(25); }
  else{ wrong++; msgEl.textContent='âœ˜ æ‹éŒ¯ï¼'; if(navigator.vibrate) navigator.vibrate([20,40,20]); }
  updateStats();
}

/* ========= æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰ ========= */
const STORE_KEY = 'note_game_leaderboard_v1';
function loadBoard(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch(_){ return []; } }
function saveBoard(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
function pushScore(entry){
  const list = loadBoard();
  list.push(entry);
  // ä¾æ­£ç¢ºç‡ descï¼Œå†ä¾é€Ÿåº¦ï¼ˆè¶Šå¿«è¶Šå‰ï¼‰ascï¼Œå†ä¾æ—¥æœŸ desc
  list.sort((a,b)=> b.acc - a.acc || a.speed - b.speed || (b.time - a.time));
  saveBoard(list.slice(0,20)); // åªç•™å‰ 20
}
function fmtTime(t){ const d=new Date(t); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${p(d.getMonth()+1)}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }
function renderBoard(){
  const tbody = document.querySelector('#boardTable tbody');
  tbody.innerHTML = '';
  loadBoard().forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${r.name}</td>
      <td><b>${r.acc}%</b></td>
      <td>${r.correct}/${r.wrong}/${r.miss}</td>
      <td>${(r.speed/1000).toFixed(2)}s</td>
      <td>${r.diff}%</td>
      <td>${fmtTime(r.time)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ========= æˆç¸¾çµæŸèˆ‡å­˜æª” ========= */
function finish(){
  running=false; if(timer){clearTimeout(timer); timer=null;}
  if(shouldHit){ missed++; shouldHit=false; }
  updateStats();

  const total = hitCount + wrong + missed;
  const acc = total ? Math.round(hitCount/total*100) : 0;
  let grade="å¤ªå¼·äº†ï¼", cls="good";
  if(acc>=90){ grade="å¤ªå¼·äº†ï¼å®Œç¾è½åŠ›ï¼"; cls="good"; }
  else if(acc>=75){ grade="å¾ˆä¸éŒ¯ï¼å†æŒ‘æˆ°æ›´å¿«é€Ÿåº¦å§ã€‚"; cls="mid"; }
  else if(acc>=60){ grade="æœ‰é€²æ­¥ï¼å¤šç·´å¹¾æ¬¡å°±æ›´ç©©ã€‚"; cls="low"; }
  else { grade="å»ºè­°èª¿æ…¢é€Ÿåº¦æˆ–é™ä½å›°é›£ç¨‹åº¦ã€‚"; cls="badc"; }

  document.getElementById('rHit').textContent=hitCount;
  document.getElementById('rWrong').textContent=wrong;
  document.getElementById('rMissed').textContent=missed;
  document.getElementById('rAcc').textContent=acc+'%';
  const g=document.getElementById('rGrade'); g.className='grade '+cls; g.textContent=grade;

  // å­˜åˆ°æ’è¡Œæ¦œ
  setTimeout(()=>{
    let name = prompt('è¼¸å…¥åç¨±ä»¥å„²å­˜åˆ°æ’è¡Œæ¦œï¼ˆå¯ç•™ç©ºä½¿ç”¨ã€Œç©å®¶ã€ï¼‰ï¼š') || 'ç©å®¶';
    pushScore({ name, acc, correct:hitCount, wrong, miss:missed, speed:interval, diff:parseInt(mismatchEl.value,10), time:Date.now() });
  }, 200);

  document.getElementById('result').style.display='flex';
}

/* ========= äº‹ä»¶ ========= */
document.getElementById('start').onclick=startGame;
document.getElementById('startNow').onclick=startGame;
document.getElementById('pause').onclick=togglePause;
document.getElementById('reset').onclick=resetGame;
document.getElementById('hitBtn').onclick=onHit;
document.getElementById('retry').onclick=()=>{ document.getElementById('result').style.display='none'; resetGame(); startGame(); };
document.addEventListener('keydown',e=>{ if(e.code==='Space'){ e.preventDefault(); onHit(); } });

document.getElementById('prefSpeed').addEventListener('input',e=>{
  const v=parseInt(e.target.value,10);
  document.getElementById('prefSpeedLabel').textContent=(v/1000).toFixed(2)+'s';
});
document.getElementById('prefMismatch').addEventListener('input',e=>{
  const v=parseInt(e.target.value,10);
  document.getElementById('prefMismatchLabel').textContent=v+'%';
});

/* æ’è¡Œæ¦œé–‹é—œ */
document.getElementById('board').onclick=()=>{ renderBoard(); document.getElementById('leader').style.display='flex'; };
document.getElementById('closeBoard').onclick=()=>{ document.getElementById('leader').style.display='none'; };
document.getElementById('clearBoard').onclick=()=>{
  if(confirm('ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿæ’è¡Œæ¦œå—ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰')){
    localStorage.removeItem(STORE_KEY);
    renderBoard();
  }
};
</script>
</body>
</html>
